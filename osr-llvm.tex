% !TEX root = article.tex

\section{OSR in LLVM}
\label{se:osr-llvm}

In this section we discuss our implementation of the approach described in \mysection\ref{se:overview} in \tinyvm, a proof-of-concept virtual machine we developed as a playground to exercise our OSR techniques. TinyVM is based on LLVM's MCJIT compiler and supports interactive invocation of LLVM IR functions either generated at run-time or loaded from disk. The main design goal behind TinyVM is the creation of an interactive environment for IR manipulation and JIT-compilation of functions: for instance, it allows the user to insert OSR points in loaded functions, run optimization passes on them or display their CFGs, repeatedly invoke a function for a specified amount of times and so on. TinyVM supports dynamic library loading and linking, and comes with a helper component for MCJIT that simplifies tasks such as handling multiple IR modules, symbol resolution in presence of multiple versions of a function, and tracking native code and other machine-level generated object such as Stackmaps.

To explain how OSR can be encoded in IR, we consider the toy example of \myfigure\ref{fi:isord-example}. Function {\tt isord} checks whether an array of numbers is sorted according to some ordering given by a comparator. If the number of iterations exceeds a certain threshold, we explore how to dynamically divert control to a faster version where the comparator is inlined. To achieve this goal, we use deferred compilation by instrumenting {\tt isord} in \tinyvm\ with an open OSR, as shown in \myfigure\ref{fig:isordfrom}. The generated stub calls a function inliner that generates a version of {\tt isord} where the comparator's body is inlined in the loop body.

\ifdefined\noauthorea
\begin{figure}[t]
\begin{center}
\includegraphics[width=0.9\columnwidth]{figures/isord-example/isord.eps}
\caption{\protect\input{figures/isord-example/caption}}
\end{center}
\end{figure}
\fi

\ifdefined\noauthorea
\begin{figure}[t]
\begin{center}
\includegraphics[width=0.9\columnwidth]{figures/isordfrom/isordfrom.eps}
\caption{\protect\input{figures/isordfrom/caption}}
\end{center}
\end{figure}
\fi

\ifdefined\noauthorea
\begin{figure}[t]
\begin{center}
\includegraphics[width=0.9\columnwidth]{figures/isordascto/isordascto.eps}
\caption{\protect\input{figures/isordascto/caption}}
\end{center}
\end{figure}
\fi

\ifdefined\noauthorea
\begin{figure}[t]
\begin{center}
\includegraphics[width=0.9\columnwidth]{figures/isordx86-64/isordx86-64.eps}
\caption{\protect\input{figures/isordx86-64/caption}}
\end{center}
\end{figure}
\fi

%\subsection{Resolved OSR Points}

%\subsection{Open OSR Points}
  

  
  
  
  